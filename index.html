<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --surface: rgba(30, 41, 59, 0.7);
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --grad: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --danger: #ff4b4b;
            --success: #00e676;
        }
        body { background: var(--grad); color: var(--text-main); font-family: 'Inter', -apple-system, sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .screen { display: none; padding: 20px; flex: 1; overflow-y: auto; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .active { display: flex; flex-direction: column; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 24px; text-align: center; }

        .mode-card { background: var(--surface); backdrop-filter: blur(12px); border-radius: 24px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 20px; cursor: pointer; transition: all 0.2s; }
        .mode-card:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }
        .mode-icon { font-size: 2.2rem; background: rgba(255,255,255,0.05); width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; border-radius: 18px; }
        .mode-info h3 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .mode-info p { margin: 4px 0 0; font-size: 0.9rem; color: var(--text-dim); line-height: 1.4; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 12px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-dim); font-size: 0.7rem; transition: 0.3s; width: 60px; }
        .nav-item.active { color: var(--accent); transform: translateY(-2px); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 4px; }

        /* –ü–æ–∏—Å–∫ –∏ –ö–∞—Ä—Ç–æ—á–∫–∞ */
        #search-screen { padding: 10px 10px 0 10px; }
        .tinder-card { width: 100%; max-width: 380px; height: 81vh; background: var(--card-bg); border-radius: 32px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); display: flex; flex-direction: column; margin: 0 auto; position: relative; }
        .poster-wrapper { width: 100%; height: 55%; position: relative; overflow: hidden; background: #000; }
        .poster-blur { position: absolute; width: 100%; height: 100%; object-fit: cover; filter: blur(20px) brightness(0.5); transform: scale(1.2); }
        .tinder-img { position: relative; width: 100%; height: 100%; object-fit: contain; z-index: 1; opacity: 0; transition: opacity 0.5s ease; }
        .tinder-img.loaded { opacity: 1; }
        .tinder-info-container { flex: 1; padding: 15px 20px; display: flex; flex-direction: column; gap: 6px; background: linear-gradient(180deg, rgba(30,41,59,0) 0%, rgba(30,41,59,1) 15%); margin-top: -20px; position: relative; z-index: 2; overflow-y: auto; }
        .rating-badge { align-self: flex-start; background: var(--accent); color: #000; padding: 3px 10px; border-radius: 8px; font-weight: 800; font-size: 0.8rem; margin-bottom: 4px; }
        .tinder-info h2 { font-size: 1.35rem; margin: 0; font-weight: 800; color: #fff; line-height: 1.2; }
        .movie-meta { font-size: 0.85rem; color: var(--text-dim); }
        .movie-desc { font-size: 0.9rem; color: #cbd5e1; line-height: 1.4; margin-top: 4px; }
        .tinder-btns { display: flex; justify-content: center; gap: 40px; padding: 15px 20px 20px; background: rgba(15, 23, 42, 0.8); z-index: 3; }
        .btn-circle { width: 65px; height: 65px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; cursor: pointer; transition: 0.2s; }
        .btn-circle:active { transform: scale(0.85); }
        .btn-dislike { background: #fff; color: var(--danger); }
        .btn-like { background: var(--success); color: #fff; }
        .action-btn { background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 18px; width: 100%; font-weight: 700; font-size: 1rem; margin-top: 12px; cursor: pointer; }

        /* –ñ–∞–Ω—Ä—ã –∏ –ø—Ä–æ—á–µ–µ */
        .genre-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 20px; }
        .genre-btn { background: var(--surface); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 16px; text-align: center; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .genre-btn:active { background: var(--accent); color: #000; transform: scale(0.98); }
        .partner-badge { width: 100%; max-width: 380px; margin: 0 auto 10px; background: rgba(56, 189, 248, 0.15); color: var(--accent); padding: 10px; border-radius: 12px; text-align: center; font-weight: 700; font-size: 0.9rem; border: 1px solid rgba(56, 189, 248, 0.3); display: none; }
        .exit-btn { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 10; transition: 0.2s; }
        .exit-btn:active { transform: scale(0.9); background: var(--danger); border-color: var(--danger); }

        /* –ê–¥–º–∏–Ω–∫–∞ –∏ –¢–∏–∫–µ—Ç—ã */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
        .stat-lbl { font-size: 0.8rem; color: var(--text-dim); }

        .ticket-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .ticket-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 8px; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .status-open { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.4); }
        .status-closed { background: rgba(0, 230, 118, 0.2); color: #00e676; border: 1px solid rgba(0, 230, 118, 0.4); }
        .admin-reply { margin-top: 10px; padding: 10px; background: rgba(56, 189, 248, 0.1); border-left: 3px solid var(--accent); border-radius: 4px; font-size: 0.9rem; color: #e2e8f0; }

        textarea {
    width: 100%;
    min-height: 100px; /* <--- –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û –ó–ù–ê–ß–ï–ù–ò–ï (–Ω–∞–ø—Ä–∏–º–µ—Ä 100px –∏–ª–∏ 200px) */
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    padding: 10px;
    border-radius: 12px;
    margin: 10px 0;
    font-family: inherit;
    box-sizing: border-box;
    resize: vertical; /* –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–∞–º–æ–º—É —Ç—è–Ω—É—Ç—å –∑–∞ —É–≥–æ–ª–æ–∫ */
}

        .reply-box { display: flex; gap: 10px; margin-top: 10px; }
        .reply-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #ffffff30; color: white; border-radius: 8px; padding: 8px; }
     
        /* --- –£–Æ–¢–ù–´–ô –§–û–ù (–í–ê–†–ò–ê–ù–¢ 3) --- */
                .cozy-filler {
            flex: 1; 
            width: 100%;
            margin-top: 30px;
            position: relative;
            /* –£–±–∏—Ä–∞–µ–º overflow:hidden, —á—Ç–æ–±—ã –∏—Å–∫–æ—Ä–∫–∏ –º–æ–≥–ª–∏ –ª–µ—Ç–∞—Ç—å */
            border-radius: 30px 30px 0 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .cozy-image {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('https://images.unsplash.com/photo-1576014131341-fe1486ade247?q=80&w=600&auto=format&fit=crop');
            background-size: cover;
            background-position: center bottom;
            opacity: 0.8;
            border-radius: 30px 30px 0 0;
        }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì—Ä–∞–¥–∏–µ–Ω—Ç –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Å–≤–µ—Ä—Ö—É –ø—Å–µ–≤–¥–æ-—ç–ª–µ–º–µ–Ω—Ç–æ–º */
        .cozy-image::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–º—É */
            background: linear-gradient(to bottom, #0f172a 0%, rgba(15, 23, 42, 0) 60%);
        }


        .cozy-text {
            position: relative;
            z-index: 2;
            padding-bottom: 90px; /* –û—Ç—Å—Ç—É–ø —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
            text-align: center;
        }

        .cozy-text h4 {
            margin: 0;
            color: #fbbf24; /* –ó–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç */
            font-size: 1.1rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            letter-spacing: 1px;
        }

        .cozy-text span {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å–∫–æ—Ä–æ–∫ */
        .sparkle {
            position: absolute;
            width: 4px; height: 4px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
            animation: rise 4s infinite ease-in;
            opacity: 0;
        }

        @keyframes rise {
            0% { transform: translateY(100%) scale(0); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(0%) scale(1.5); opacity: 0; }
        }

    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <h1>MovieMatch</h1>
        <div class="mode-card" onclick="selectMode('solo')"><div class="mode-icon">üçø</div><div class="mode-info"><h3>–û–¥–∏–Ω</h3><p>–õ–∏—Å—Ç–∞–π –ø–æ–¥–±–æ—Ä–∫—É –¥–ª—è —Å–µ–±—è</p></div></div>
        <div class="mode-card" onclick="showDuoMenu()"><div class="mode-icon">üë´</div><div class="mode-info"><h3>–í–¥–≤–æ–µ–º</h3><p>–ù–∞–π–¥–∏ –æ–±—â–∏–π –º–∞—Ç—á —Å –¥—Ä—É–≥–æ–º</p></div></div>
         <!-- üëáüëáüëá –£–Æ–¢–ù–´–ô –§–û–ù üëáüëáüëá -->
        <div class="cozy-filler">
            <div class="cozy-image"></div>

            <!-- –ò—Å–∫–æ—Ä–∫–∏ (—Ä–∞–∑–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏) -->
            <div class="sparkle" style="left: 20%; animation-duration: 5s; animation-delay: 0s;"></div>
            <div class="sparkle" style="left: 50%; animation-duration: 7s; animation-delay: 2s;"></div>
            <div class="sparkle" style="left: 80%; animation-duration: 6s; animation-delay: 1s;"></div>
            <div class="sparkle" style="left: 35%; animation-duration: 8s; animation-delay: 4s;"></div>

            <div class="cozy-text">
                <h4>–° –ü—Ä–∞–∑–¥–Ω–∏–∫–∞–º–∏! ‚ú®</h4>
                <span>–í—ã–±–∏—Ä–∞–π —Ñ–∏–ª—å–º –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è</span>
            </div>
        </div>
        <!-- üëÜüëÜüëÜ –ö–û–ù–ï–¶ –í–°–¢–ê–í–ö–ò üëÜüëÜüëÜ -->

    </div>
    </div>

    <div id="genre-screen" class="screen">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</h1>
        <div class="genre-grid" id="genre-list"></div>
        <button class="action-btn" style="background: rgba(255,255,255,0.1); color: #fff;" onclick="switchTab('home', document.querySelectorAll('.nav-item')[0])">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="search-screen" class="screen">
        <div id="partner-badge" class="partner-badge">–í –∫–æ–º–Ω–∞—Ç–µ —Å: –ò–º—è</div>
        <div class="tinder-card">
            <div class="exit-btn" onclick="exitSearch()">‚úï</div>
            <div class="poster-wrapper"><img id="poster-blur" class="poster-blur" src=""><img id="poster" class="tinder-img" src=""></div>
            <div class="tinder-info-container">
                <div id="rating" class="rating-badge">0.0</div>
                <div class="tinder-info"><h2 id="title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2></div>
                <div id="meta" class="movie-meta">---- ‚Ä¢ –ö–∏–Ω–æ</div>
                <div id="desc" class="movie-desc">–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞...</div>
            </div>
            <div class="tinder-btns">
                <button class="btn-circle btn-dislike" onclick="handleDislike()">‚úï</button>
                <button class="btn-circle btn-like" onclick="handleLike()">‚ù§</button>
            </div>
        </div>
    </div>

    <div id="duo-menu-screen" class="screen">
        <h1>–†–µ–∂–∏–º –¥–ª—è –¥–≤–æ–∏—Ö</h1>
        <div class="mode-card" onclick="selectMode('duo_create')"><div class="mode-icon">‚ú®</div><div class="mode-info"><h3>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h3><p>–ü–æ–ª—É—á–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</p></div></div>
        <div class="mode-card" onclick="promptJoinRoom()"><div class="mode-icon">üîó</div><div class="mode-info"><h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h3><p>–í–≤–µ–¥–∏ –∫–æ–¥, –ø—Ä–∏—Å–ª–∞–Ω–Ω—ã–π –¥—Ä—É–≥–æ–º</p></div></div>
        <button class="action-btn" style="background: rgba(255,255,255,0.1); color: #fff;" onclick="switchTab('home', document.querySelectorAll('.nav-item')[0])">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="profile-screen" class="screen">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <div class="mode-card" style="background: linear-gradient(90deg, #38bdf8 0%, #818cf8 100%); color: #000;">
            <div class="mode-info"><h3 id="user-name">–ö–∏–Ω–æ–º–∞–Ω</h3><p id="user-id">ID: 000000</p></div>
        </div>
        <h3 style="margin-top: 30px;">–ö–æ–ª–ª–µ–∫—Ü–∏—è ‚ù§Ô∏è</h3>
        <div id="likes-list"></div>
    </div>

    <!-- –ü–û–î–î–ï–†–ñ–ö–ê -->
    <div id="support-screen" class="screen">
        <h1>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
        <p style="color:var(--text-dim); font-size:0.9rem; margin-bottom:15px;">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É, –º—ã –æ—Ç–≤–µ—Ç–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:</p>

        <textarea id="ticket-text" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button class="action-btn" onclick="createTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>

        <h3 style="margin-top: 30px;">–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
        <div id="my-tickets-list"></div>
    </div>

    <!-- –ê–î–ú–ò–ù–ö–ê -->
    <div id="admin-screen" class="screen">
        <h1>üõ† –ê–¥–º–∏–Ω–∫–∞</h1>
        <div class="stat-grid">
            <div class="stat-item"><div id="adm-users" class="stat-val">0</div><div class="stat-lbl">–Æ–∑–µ—Ä—ã</div></div>
            <div class="stat-item"><div id="adm-likes" class="stat-val">0</div><div class="stat-lbl">–õ–∞–π–∫–∏</div></div>
            <div class="stat-item"><div id="adm-rooms" class="stat-val">0</div><div class="stat-lbl">–ö–æ–º–Ω–∞—Ç—ã</div></div>
            <div class="stat-item"><div id="adm-tickets" class="stat-val">0</div><div class="stat-lbl">–¢–∏–∫–µ—Ç—ã</div></div>
        </div>
        <h3>üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h3>
        <textarea id="broadcast-text" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
        <button class="action-btn" onclick="sendBroadcast()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</button>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom:10px;">
            <h3>üì© –¢–∏–∫–µ—Ç—ã</h3>
            <button onclick="loadAdminData()" style="background:none; border:none; color:var(--accent); font-size:1.2rem;">üîÑ</button>
        </div>
        <div id="tickets-list"></div>
        <button class="action-btn" style="background: rgba(255,255,255,0.1); color: #fff; margin-top: 30px;" onclick="switchTab('home')">–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏</button>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('home', this)"><span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
        <div class="nav-item" onclick="switchTab('profile', this)"><span class="nav-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
        <div class="nav-item" onclick="switchTab('support', this)"><span class="nav-icon">üì©</span><span>–ü–æ–º–æ—â—å</span></div>
        <div id="nav-admin" class="nav-item" style="display: none; color: #ff4b4b;" onclick="switchTab('admin', this)"><span class="nav-icon">üîë</span><span>–ê–¥–º–∏–Ω</span></div>
    </nav>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.backgroundColor = '#0f172a';
        tg.headerColor = '#0f172a';

        const API_BASE = "https://larviparous-intercondylic-sherilyn.ngrok-free.dev".replace(/\/$/, "");

        let isLoading = false;
        let abortController = null;
        let currentMovieId = null;
        let currentGenre = 'all';
        let currentMode = 'solo';
        let myRoomId = null;
        let pollingInterval = null;

        const GENRES = [
            {id: 'all', name: 'üé≤ –°–ª—É—á–∞–π–Ω—ã–µ'}, {id: '1', name: 'üí• –ë–æ–µ–≤–∏–∫'}, {id: '13', name: 'ü§° –ö–æ–º–µ–¥–∏—è'},
            {id: '17', name: 'üò± –£–∂–∞—Å—ã'}, {id: '18', name: 'üé≠ –î—Ä–∞–º–∞'}, {id: '12', name: 'üßö –§—ç–Ω—Ç–µ–∑–∏'},
            {id: '6', name: 'üöÄ –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞'}, {id: '10', name: 'ü§† –í–µ—Å—Ç–µ—Ä–Ω'}
        ];

        async function checkAdmin() {
            const uid = tg.initDataUnsafe.user?.id;
            if(!uid) return;
            try {
                const res = await fetch(`${API_BASE}/admin/check/${uid}`, {headers: {'ngrok-skip-browser-warning':'true'}});
                if(res.ok) {
                    const data = await res.json();
                    if(data.is_admin) document.getElementById('nav-admin').style.display = 'flex';
                }
            } catch(e) {}
        }
        checkAdmin();

        function renderGenres() {
            document.getElementById('genre-list').innerHTML = GENRES.map(g => `<div class="genre-btn" onclick="chooseGenre('${g.id}')">${g.name}</div>`).join('');
        }
        renderGenres();

        function switchTab(screen, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(screen + '-screen').classList.add('active');
            if (el) el.classList.add('active');

            if(screen === 'profile') loadMyLikes();
            if(screen === 'admin') loadAdminData();
            if(screen === 'support') loadMyTickets();
            tg.HapticFeedback.impactOccurred('medium');
        }

        // --- –ü–û–î–î–ï–†–ñ–ö–ê ---
        async function createTicket() {
            const txt = document.getElementById('ticket-text').value;
            const uid = tg.initDataUnsafe.user?.id;
            if(!txt) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");

            try {
                await fetch(`${API_BASE}/create_ticket`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'ngrok-skip-browser-warning':'true'},
                    body: JSON.stringify({ user_id: uid, message: txt })
                });
                tg.showAlert("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
                document.getElementById('ticket-text').value = "";
                loadMyTickets();
            } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
        }

        async function loadMyTickets() {
            const uid = tg.initDataUnsafe.user?.id;
            try {
                const res = await fetch(`${API_BASE}/my_tickets/${uid}`, {headers:{'ngrok-skip-browser-warning':'true'}});
                const tickets = await res.json();
                const list = document.getElementById('my-tickets-list');

                if(!tickets.length) list.innerHTML = '<div style="text-align:center;color:gray;padding:20px">–û–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ—Ç</div>';
                else list.innerHTML = tickets.map(t => {
                    const statusClass = t.status === 'open' ? 'status-open' : 'status-closed';
                    const statusText = t.status === 'open' ? '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' : '–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω';

                    // –ë–ª–æ–∫ —Å –æ—Ç–≤–µ—Ç–æ–º –∞–¥–º–∏–Ω–∞
                    let replyBlock = '';
                    if (t.admin_reply) {
                        replyBlock = `<div class="admin-reply"><b>–û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏:</b><br>${t.admin_reply}</div>`;
                    }

                    return `
                    <div class="ticket-card">
                        <div class="ticket-header">
                            <span>${t.created_at.split(' ')[0]}</span>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div style="font-size:0.95rem; margin-bottom:5px;">üìù ${t.message}</div>
                        ${replyBlock}
                    </div>`;
                }).join('');
            } catch(e) {}
        }

        // --- –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        function selectMode(mode) { currentMode = mode; switchTab('genre', document.querySelectorAll('.nav-item')[0]); }
        async function chooseGenre(id) {
            currentGenre = id;
            if (currentMode === 'solo') startSearch();
            else await createRoomImpl();
        }
        function showDuoMenu() { switchTab('duo-menu', document.querySelectorAll('.nav-item')[0]); }
        function startSearch(partnerName = null) {
            switchTab('search', document.querySelectorAll('.nav-item')[0]);
            const badge = document.getElementById('partner-badge');
            if (partnerName) { badge.style.display = 'block'; badge.innerText = `–í –∫–æ–º–Ω–∞—Ç–µ —Å: ${partnerName}`; }
            else badge.style.display = 'none';
            loadMovie();
        }
        async function exitSearch() {
            if (!confirm("–í—ã–π—Ç–∏?")) return;
            if (myRoomId) {
                const uid = tg.initDataUnsafe.user?.id;
                try { await fetch(`${API_BASE}/leave_room`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: uid, room_id: myRoomId }) }); } catch(e){}
            }
            myRoomId = null;
            if (pollingInterval) clearInterval(pollingInterval);
            switchTab('home', document.querySelectorAll('.nav-item')[0]);
        }

        async function createRoomImpl() {
            const uid = tg.initDataUnsafe.user?.id;
            const name = tg.initDataUnsafe.user?.first_name || "–ò–≥—Ä–æ–∫ 1";
            try {
                const res = await fetch(`${API_BASE}/create_room`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: uid, user_name: name, genre: currentGenre }) });
                const data = await res.json();
                myRoomId = data.room_id;
                tg.showConfirm(`–ö–æ–¥: ${data.room_id}`, (ok) => {});
                pollingInterval = setInterval(checkRoomStatus, 3000);
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞"); }
        }

        async function checkRoomStatus() {
            if (!myRoomId) return;
            try {
                const res = await fetch(`${API_BASE}/check_room/${myRoomId}`, {headers: {'ngrok-skip-browser-warning': 'true'}});
                const data = await res.json();
                if (data.status === 'joined') { clearInterval(pollingInterval); tg.showAlert("–î—Ä—É–≥ –≤–æ—à–µ–ª!"); startSearch(data.partner_name); }
            } catch(e) {}
        }

        function promptJoinRoom() { const code = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:"); if (code) joinRoom(code); }
        async function joinRoom(code) {
            const uid = tg.initDataUnsafe.user?.id;
            const name = tg.initDataUnsafe.user?.first_name || "–ò–≥—Ä–æ–∫ 2";
            try {
                const res = await fetch(`${API_BASE}/join_room`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: uid, user_name: name, room_id: code }) });
                const data = await res.json();
                if (data.status === 'success') { myRoomId = code; currentGenre = data.genre; tg.showAlert("–û–ö!"); startSearch(data.partner_name); }
                else tg.showAlert(data.message);
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞"); }
        }

        async function loadMovie() {
    // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const uid = tg.initDataUnsafe.user?.id;
    if (!uid) return;

    if (isLoading && abortController) abortController.abort();

    isLoading = true;
    abortController = new AbortController();

    document.getElementById('title').innerText = "–ü–æ–¥–±–∏—Ä–∞–µ–º...";
    document.getElementById('poster').classList.remove('loaded');

    try {
        // 2. –î–æ–±–∞–≤–∏–ª–∏ user_id=${uid} –≤ –∑–∞–ø—Ä–æ—Å
        const url = `${API_BASE}/get_movie?user_id=${uid}&genre=${currentGenre}&nocache=${Date.now()}`;

        const res = await fetch(url, {
            headers: { 'ngrok-skip-browser-warning': 'true' },
            signal: abortController.signal
        });

        const data = await res.json();

        // –ï—Å–ª–∏ —Ñ–∏–ª—å–º—ã –∫–æ–Ω—á–∏–ª–∏—Å—å (—Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Ç–∞–∫–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫)
        if (data.title === "–§–∏–ª—å–º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å") {
            document.getElementById('title').innerText = "–§–∏–ª—å–º—ã –∫–æ–Ω—á–∏–ª–∏—Å—å üòî";
            document.getElementById('desc').innerText = "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–º–µ–Ω–∏—Ç—å –∂–∞–Ω—Ä.";
            document.getElementById('poster').src = "https://placehold.co/400x600/1e293b/FFF?text=End";
            isLoading = false;
            return;
        }

        currentMovieId = data.id;
        document.getElementById('title').innerText = data.title;
        document.getElementById('poster').src = data.poster;
        document.getElementById('poster-blur').src = data.poster;
        document.getElementById('desc').innerText = data.description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
        document.getElementById('rating').innerText = data.rating;
        document.getElementById('meta').innerText = `${data.year} ‚Ä¢ ${data.genres}`;

        document.getElementById('poster').onload = () => {
            document.getElementById('poster').classList.add('loaded');
            isLoading = false;
        };
    } catch (e) {
        if(e.name !== 'AbortError') {
            isLoading = false;
            document.getElementById('title').innerText = "–û—à–∏–±–∫–∞ üîÑ";
        }
    }
}


        async function handleLike() {
            const uid = tg.initDataUnsafe.user?.id;
            if(!uid) return;
            isLoading = true;
            try {
                await fetch(`${API_BASE}/like`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: uid, movie_id: currentMovieId, movie_title: document.getElementById('title').innerText, poster_url: document.getElementById('poster').src })
                });
                isLoading = false; loadMovie();
            } catch(e) { isLoading = false; }
        }

        async function handleDislike() {
    if (isLoading) return;
    const uid = tg.initDataUnsafe.user?.id;
    const title = document.getElementById('title').innerText;

    // –°—Ä–∞–∑—É –≥—Ä—É–∑–∏–º —Å–ª–µ–¥—É—é—â–∏–π, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å
    loadMovie();

    // –í —Ñ–æ–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏–Ω—Ñ—É, —á—Ç–æ —Ñ–∏–ª—å–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω
    try {
        await fetch(`${API_BASE}/dislike`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
            body: JSON.stringify({
                user_id: uid,
                movie_id: currentMovieId,
                movie_title: title,
                poster_url: ""
            })
        });
    } catch (e) {}
}


        async function loadMyLikes() {
            const uid = tg.initDataUnsafe.user?.id;
            try {
                const res = await fetch(`${API_BASE}/get_likes/${uid}`, {headers: {'ngrok-skip-browser-warning': 'true'}});
                const data = await res.json();
                document.getElementById('likes-list').innerHTML = data.length ? data.map(m => `<div class="mode-card" style="padding:10px;"><img src="${m.poster}" style="width:40px;height:60px;border-radius:8px;margin-right:10px;"><div>${m.title}</div></div>`).join('') : '<div style="text-align:center;color:gray;">–ü—É—Å—Ç–æ</div>';
            } catch(e) {}
        }

        // –ê–¥–º–∏–Ω–∫–∞
        async function loadAdminData() {
            const uid = tg.initDataUnsafe.user?.id;
            const h = { 'ngrok-skip-browser-warning': 'true' };
            const s = await (await fetch(`${API_BASE}/admin/stats/${uid}`, { headers: h })).json();
            document.getElementById('adm-users').innerText = s.users; document.getElementById('adm-likes').innerText = s.likes;
            document.getElementById('adm-rooms').innerText = s.rooms; document.getElementById('adm-tickets').innerText = s.tickets;
            const t = await (await fetch(`${API_BASE}/admin/tickets/${uid}`, { headers: h })).json();
            document.getElementById('tickets-list').innerHTML = t.map(tik =>
                `<div class="ticket-card"><div class="ticket-header"><span>${tik.user_id}</span><span>${tik.msg_type}</span></div><div style="margin-bottom:8px">"${tik.message}"</div><div class="reply-box"><input id="rep-${tik.id}" class="reply-input"><button onclick="reply(${tik.id})" style="background:var(--accent);border:none;border-radius:8px;">‚ûú</button></div></div>`
            ).join('');
        }
        async function reply(tid) {
            const txt = document.getElementById(`rep-${tid}`).value;
            const uid = tg.initDataUnsafe.user?.id;
            await fetch(`${API_BASE}/admin/reply_ticket`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({admin_id:uid, ticket_id:tid, text:txt})});
            loadAdminData();
        }
        async function sendBroadcast() {
            const txt = document.getElementById('broadcast-text').value;
            const uid = tg.initDataUnsafe.user?.id;
            if(confirm("–í—Å–µ–º?")) await fetch(`${API_BASE}/admin/broadcast`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({admin_id:uid, text:txt})});
        }

        document.getElementById('user-name').innerText = tg.initDataUnsafe.user?.first_name || "–ö–∏–Ω–æ–º–∞–Ω";
        document.getElementById('user-id').innerText = "ID: " + (tg.initDataUnsafe.user?.id || "---");
    </script>
</body>
</html>
