<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --surface: rgba(30, 41, 59, 0.7);
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --grad: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --danger: #ff4b4b;
            --success: #00e676;
        }
        body { background: var(--grad); color: var(--text-main); font-family: 'Inter', -apple-system, sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .screen { display: none; padding: 20px; flex: 1; overflow-y: auto; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .active { display: flex; flex-direction: column; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 24px; text-align: center; }

        .mode-card { background: var(--surface); backdrop-filter: blur(12px); border-radius: 24px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 20px; cursor: pointer; transition: all 0.2s; }
        .mode-card:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }
        .mode-icon { font-size: 2.2rem; background: rgba(255,255,255,0.05); width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; border-radius: 18px; }
        .mode-info h3 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .mode-info p { margin: 4px 0 0; font-size: 0.9rem; color: var(--text-dim); line-height: 1.4; }

        canvas {
    pointer-events: none !important;
    position: fixed !important;
    z-index: 10002 !important;
}

        /* --- CYBERPUNK NEON NAVIGATION --- */
        .nav-bar {
            position: fixed;
            bottom: 15px; left: 15px; right: 15px;

            /* –¢–µ–º–Ω—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);

            /* –ì—Ä–∞–Ω–∏—Ü—ã: —Å–Ω–∏–∑—É —è—Ä—á–µ (–ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≥—Ä–∞–Ω–∏) */
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;

            display: flex;
            justify-content: space-around;
            padding: 12px;
            z-index: 1000;

            /* –ì–õ–ê–í–ù–´–ô –≠–§–§–ï–ö–¢: –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ —Å–Ω–∏–∑—É */
            animation: neon-breathe 4s infinite alternate ease-in-out;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è "–î—ã—Ö–∞–Ω–∏—è" (—Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ —Ç–µ–Ω–∏) */
        @keyframes neon-breathe {
            0% {
                box-shadow: 0 10px 30px -5px rgba(139, 92, 246, 0.4), /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
                            inset 0 0 20px rgba(139, 92, 246, 0.1);
                border-bottom-color: rgba(139, 92, 246, 0.5);
            }
            100% {
                box-shadow: 0 10px 30px -5px rgba(6, 182, 212, 0.5), /* –ì–æ–ª—É–±–æ–π */
                            inset 0 0 20px rgba(6, 182, 212, 0.1);
                border-bottom-color: rgba(6, 182, 212, 0.5);
            }
        }

        /* –ê–∫—Ç–∏–≤–Ω–∞—è –∏–∫–æ–Ω–∫–∞ (–°–≤–µ—Ç–∏—Ç—Å—è) */
        .nav-item.active {
            color: #fff;
            transform: translateY(-2px);
        }

        .nav-item.active .nav-icon {
            /* –ù–µ–æ–Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç */
            text-shadow: 0 0 10px currentColor;
            animation: icon-flicker 3s infinite;
        }

        @keyframes icon-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
            52% { opacity: 1; }
            54% { opacity: 0.8; }
        }

        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-dim); font-size: 0.7rem; transition: 0.3s; width: 60px; }
        .nav-item.active { color: var(--accent); transform: translateY(-2px); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 4px; }

        /* –ü–æ–∏—Å–∫ –∏ –ö–∞—Ä—Ç–æ—á–∫–∞ */
        #search-screen { padding: 10px 10px 0 10px; }
        .tinder-card { width: 100%; max-width: 380px; height: 81vh; background: var(--card-bg); border-radius: 32px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); display: flex; flex-direction: column; margin: 0 auto; position: relative; }
        .poster-wrapper { width: 100%; height: 55%; position: relative; overflow: hidden; background: #000; }
        .poster-blur { position: absolute; width: 100%; height: 100%; object-fit: cover; filter: blur(20px) brightness(0.5); transform: scale(1.2); }
        .tinder-img { position: relative; width: 100%; height: 100%; object-fit: contain; z-index: 1; opacity: 0; transition: opacity 0.5s ease; }
        .tinder-img.loaded { opacity: 1; }
        .tinder-info-container { flex: 1; padding: 15px 20px; display: flex; flex-direction: column; gap: 6px; background: linear-gradient(180deg, rgba(30,41,59,0) 0%, rgba(30,41,59,1) 15%); margin-top: -20px; position: relative; z-index: 2; overflow-y: auto; }
        .rating-badge { align-self: flex-start; background: var(--accent); color: #000; padding: 3px 10px; border-radius: 8px; font-weight: 800; font-size: 0.8rem; margin-bottom: 4px; }
        .tinder-info h2 { font-size: 1.35rem; margin: 0; font-weight: 800; color: #fff; line-height: 1.2; }
        .movie-meta { font-size: 0.85rem; color: var(--text-dim); }
        .movie-desc { font-size: 0.9rem; color: #cbd5e1; line-height: 1.4; margin-top: 4px; }
        .tinder-btns { display: flex; justify-content: center; gap: 40px; padding: 15px 20px 20px; background: rgba(15, 23, 42, 0.8); z-index: 3; }
        .btn-circle { width: 65px; height: 65px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; cursor: pointer; transition: 0.2s; }
        .btn-circle:active { transform: scale(0.85); }
        .btn-dislike { background: #fff; color: var(--danger); }
        .btn-like { background: var(--success); color: #fff; }
        .action-btn { background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 18px; width: 100%; font-weight: 700; font-size: 1rem; margin-top: 12px; cursor: pointer; }

        /* –ñ–∞–Ω—Ä—ã –∏ –ø—Ä–æ—á–µ–µ */
        .genre-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 20px; }
        .genre-btn { background: var(--surface); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 16px; text-align: center; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .genre-btn:active { background: var(--accent); color: #000; transform: scale(0.98); }
        .partner-badge { width: 100%; max-width: 380px; margin: 0 auto 10px; background: rgba(56, 189, 248, 0.15); color: var(--accent); padding: 10px; border-radius: 12px; text-align: center; font-weight: 700; font-size: 0.9rem; border: 1px solid rgba(56, 189, 248, 0.3); display: none; }
        .exit-btn { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 10; transition: 0.2s; }
        .exit-btn:active { transform: scale(0.9); background: var(--danger); border-color: var(--danger); }

        /* –ê–¥–º–∏–Ω–∫–∞ –∏ –¢–∏–∫–µ—Ç—ã */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
        .stat-lbl { font-size: 0.8rem; color: var(--text-dim); }

        .ticket-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .ticket-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 8px; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .status-open { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.4); }
        .status-closed { background: rgba(0, 230, 118, 0.2); color: #00e676; border: 1px solid rgba(0, 230, 118, 0.4); }
        .admin-reply { margin-top: 10px; padding: 10px; background: rgba(56, 189, 248, 0.1); border-left: 3px solid var(--accent); border-radius: 4px; font-size: 0.9rem; color: #e2e8f0; }

        textarea {
    width: 100%;
    min-height: 100px; /* <--- –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û –ó–ù–ê–ß–ï–ù–ò–ï (–Ω–∞–ø—Ä–∏–º–µ—Ä 100px –∏–ª–∏ 200px) */
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    padding: 10px;
    border-radius: 12px;
    margin: 10px 0;
    font-family: inherit;
    box-sizing: border-box;
    resize: vertical; /* –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–∞–º–æ–º—É —Ç—è–Ω—É—Ç—å –∑–∞ —É–≥–æ–ª–æ–∫ */
}

        .reply-box { display: flex; gap: 10px; margin-top: 10px; }
        .reply-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #ffffff30; color: white; border-radius: 8px; padding: 8px; }
        /* --- PREMIUM UI: CINEMATIC AURORA (ROUNDED & FIXED) --- */
        .cinema-atmosphere {
            /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ */
            height: 200px;
            min-height: 200px;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –°–ù–ò–ó–£, —á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ */

            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;

            /* –°–∫—Ä—É–≥–ª—è–µ–º —É–≥–ª—ã */
            border-radius: 24px;
            /* –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–∫—É—é —Ä–∞–º–∫—É */
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* –§–æ–Ω —Å–∞–º–æ–≥–æ –±–ª–æ–∫–∞ */
            background: rgba(15, 23, 42, 0.5);
            /* –¢–µ–Ω—å */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* 1. –ñ–∏–≤–æ–µ —Å–∏—è–Ω–∏–µ (Aurora) - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ */
        .aurora-blob {
            position: absolute;
            filter: blur(50px);
            opacity: 0.5;
            animation: aurora-move 8s infinite alternate ease-in-out;
            z-index: 0;
        }
        .blob-1 {
            top: -20%; left: -20%; width: 200px; height: 200px;
            background: #3b82f6; /* Blue */
        }
        .blob-2 {
            bottom: -20%; right: -20%; width: 180px; height: 180px;
            background: #8b5cf6; /* Purple */
            animation-delay: -2s;
        }

        /* 2. –°–µ—Ç–∫–∞ */
        .texture-grid {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            z-index: 1;
            opacity: 0.3;
        }

        /* 3. –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–µ–π–∑–∞–∂ (–ü–æ–¥—Ä–µ–∑–∞–Ω –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫—É) */
        .skyline-svg {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: auto;
            z-index: 2;
            opacity: 0.9;
        }

        /* 4. –¢–µ–∫—Å—Ç */
        .atmosphere-text {
            position: relative;
            z-index: 3;
            text-align: center;
            margin-bottom: 120px; /* –ü–æ–¥–Ω—è–ª–∏ —Ç–µ–∫—Å—Ç —á—É—Ç—å –≤—ã—à–µ */
        }
        .atmosphere-text h4 {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 0;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }
        .atmosphere-text p {
            font-size: 0.75rem;
            color: #94a3b8;
            margin: 4px 0 0 0;
        }

        /* 5. –ß–∞—Å—Ç–∏—Ü—ã */
        .magic-particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: float-magic 5s infinite linear;
        }

        @keyframes aurora-move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, 20px); }
        }
        @keyframes float-magic {
            0% { transform: translateY(100px); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
                /* --- –ù–ï–û–ù–û–í–ê–Ø –ì–ò–†–õ–Ø–ù–î–ê --- */

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ª–∞–º–ø–æ—á–µ–∫ */
        .garland-wrap {
            position: absolute;
            left: 0;
            width: 100%;
            pointer-events: none;
            z-index: 2000;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            box-sizing: border-box;
        }

        /* –ü–æ–∑–∏—Ü–∏—è –¥–ª—è –ú–µ–Ω—é (—Å–≤–µ—Ä—Ö—É) */
        .garland-nav {
            top: -6px;
        }

        /* –ü–æ–∑–∏—Ü–∏—è –¥–ª—è –ó–∞–≥–æ–ª–æ–≤–∫–∞ (—Å–Ω–∏–∑—É, –¥—É–≥–æ–π) */
        .garland-title {
            bottom: -5px;
            justify-content: center;
            gap: 15px;
        }

        /* –°–∞–º–∞ –ª–∞–º–ø–æ—á–∫–∞ */
        .bulb {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #444; /* –í—ã–∫–ª—é—á–µ–Ω–Ω–∞—è */
            animation: flash 1.5s infinite alternate;
            position: relative;
        }

        /* –ü—Ä–æ–≤–æ–¥ (–º–∞–ª–µ–Ω—å–∫–∞—è –ø–∞–ª–æ—á–∫–∞ –Ω–∞–¥ –ª–∞–º–ø–æ—á–∫–æ–π) */
        .bulb::before {
            content: '';
            position: absolute;
            top: -3px; left: 2px;
            width: 2px; height: 4px;
            background: #222;
        }

        /* –¶–≤–µ—Ç–∞ –∏ —Å–≤–µ—á–µ–Ω–∏–µ */
        .b-red { background: #ff0055; box-shadow: 0 0 10px #ff0055; animation-delay: 0s; }
        .b-green { background: #00ff99; box-shadow: 0 0 10px #00ff99; animation-delay: 0.5s; }
        .b-blue { background: #00ccff; box-shadow: 0 0 10px #00ccff; animation-delay: 1s; }
        .b-gold { background: #ffcc00; box-shadow: 0 0 10px #ffcc00; animation-delay: 0.2s; }

        @keyframes flash {
            0% { opacity: 0.4; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        /* –°–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ (—á—Ç–æ–±—ã –ª–∞–º–ø–æ—á–∫–∏ –≤–∏—Å–µ–ª–∏ –¥—É–≥–æ–π) */
        .garland-title .bulb:nth-child(1) { transform: translateY(-5px); }
        .garland-title .bulb:nth-child(2) { transform: translateY(-2px); }
        .garland-title .bulb:nth-child(3) { transform: translateY(0px); }
        .garland-title .bulb:nth-child(4) { transform: translateY(-2px); }
        .garland-title .bulb:nth-child(5) { transform: translateY(-5px); }


    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <div id="home-screen" class="screen active">
                <div style="position: relative; width: fit-content; margin: 0 auto 24px;">
            <h1 style="margin: 0;">MovieMatch</h1>
            <!-- –ì–∏—Ä–ª—è–Ω–¥–∞ –ø–æ–¥ —Ç–µ–∫—Å—Ç–æ–º -->
            <div class="garland-wrap garland-title">
                <div class="bulb b-red"></div>
                <div class="bulb b-gold"></div>
                <div class="bulb b-green"></div>
                <div class="bulb b-blue"></div>
                <div class="bulb b-red"></div>
            </div>
        </div>

        <div class="mode-card" onclick="selectMode('solo')"><div class="mode-icon">üçø</div><div class="mode-info"><h3>–û–¥–∏–Ω</h3><p>–õ–∏—Å—Ç–∞–π –ø–æ–¥–±–æ—Ä–∫—É –¥–ª—è —Å–µ–±—è</p></div></div>
        <div class="mode-card" onclick="showDuoMenu()"><div class="mode-icon">üë´</div><div class="mode-info"><h3>–í–¥–≤–æ–µ–º(beta)</h3><p>–ù–∞–π–¥–∏ –æ–±—â–∏–π –º–∞—Ç—á —Å –¥—Ä—É–≥–æ–º</p></div></div>
        <!-- üëáüëáüëá –í–ò–î–ñ–ï–¢-–ö–ê–†–¢–û–ß–ö–ê: CINEMATIC AURORA üëáüëáüëá -->
        <div class="cinema-atmosphere">
            <!-- –ü—è—Ç–Ω–∞ —Å–∏—è–Ω–∏—è -->
            <div class="aurora-blob blob-1"></div>
            <div class="aurora-blob blob-2"></div>

            <!-- –°–µ—Ç–∫–∞ -->
            <div class="texture-grid"></div>

            <!-- –ß–∞—Å—Ç–∏—Ü—ã -->
            <div class="magic-particle" style="left: 20%; width: 2px; height: 2px; animation-duration: 4s;"></div>
            <div class="magic-particle" style="left: 70%; width: 3px; height: 3px; animation-duration: 6s; animation-delay: 1s;"></div>
            <div class="magic-particle" style="left: 45%; width: 1px; height: 1px; animation-duration: 3s; animation-delay: 2s;"></div>

            <!-- –ü–µ–π–∑–∞–∂ (SVG) -->
            <svg class="skyline-svg" viewBox="0 0 1440 320" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
                <path fill="#1e293b" fill-opacity="1" d="M0,224L48,213.3C96,203,192,192,288,197.3C384,203,480,224,576,213.3C672,203,768,160,864,149.3C960,139,1056,160,1152,186.7C1248,213,1344,245,1392,261.3L1440,277V320H1392C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320H0Z"></path>
            </svg>

            <!-- –¢–µ–∫—Å—Ç -->
            <div class="atmosphere-text">
                <h4>WINTER VIBES</h4>
                <p>–í—Ä–µ–º—è —Ö–æ—Ä–æ—à–µ–≥–æ –∫–∏–Ω–æ</p>
            </div>
        </div>

    </div>

    <div id="genre-screen" class="screen">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</h1>
        <div class="genre-grid" id="genre-list"></div>
        <button class="action-btn" style="background: rgba(255,255,255,0.1); color: #fff;" onclick="switchTab('home', document.querySelectorAll('.nav-item')[0])">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="waiting" class="screen">
    <div style="text-align: center; padding: 40px 20px;">
        <div class="loader" style="margin: 0 auto 20px;"></div>
        <h2 style="color: var(--accent);">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</h2>
        <div style="background: var(--surface); padding: 20px; border-radius: 20px; margin: 20px 0; border: 1px dashed var(--accent);">
            <h1 id="room-code-display" style="font-size: 3.5em; letter-spacing: 8px; margin: 0; color: #fff;">----</h1>
        </div>
        <p style="color: var(--text-dim);">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä—É.<br>–ü–æ–¥–±–æ—Ä –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        <button onclick="location.reload()" style="margin-top: 40px; background: rgba(255,75,75,0.1); border: 1px solid var(--danger); color: var(--danger); padding: 12px 25px; border-radius: 12px; width: 100%;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

    <div id="search-screen" class="screen">
        <div id="partner-badge" class="partner-badge">–í –∫–æ–º–Ω–∞—Ç–µ —Å: –ò–º—è</div>
        <div class="tinder-card">
            <div class="exit-btn" onclick="exitSearch()">‚úï</div>
            <div class="poster-wrapper"><img id="poster-blur" class="poster-blur" src=""><img id="poster" class="tinder-img" src=""></div>
            <div class="tinder-info-container">
                <div id="rating" class="rating-badge">0.0</div>
                <div class="tinder-info"><h2 id="title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2></div>
                <div id="meta" class="movie-meta">---- ‚Ä¢ –ö–∏–Ω–æ</div>
                <div id="desc" class="movie-desc">–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞...</div>
            </div>
            <div class="tinder-btns">
                <button class="btn-circle btn-dislike" onclick="handleDislike()">‚úï</button>
                <button class="btn-circle btn-like" onclick="handleLike()">‚ù§</button>
            </div>
        </div>
    </div>

    <div id="duo-menu-screen" class="screen">
        <h1>–†–µ–∂–∏–º –¥–ª—è –¥–≤–æ–∏—Ö</h1>
        <div class="mode-card" onclick="selectMode('duo_create')"><div class="mode-icon">‚ú®</div><div class="mode-info"><h3>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h3><p>–ü–æ–ª—É—á–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</p></div></div>
        <div class="mode-card" onclick="promptJoinRoom()"><div class="mode-icon">üîó</div><div class="mode-info"><h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h3><p>–í–≤–µ–¥–∏ –∫–æ–¥, –ø—Ä–∏—Å–ª–∞–Ω–Ω—ã–π –¥—Ä—É–≥–æ–º</p></div></div>
        <button class="action-btn" style="background: rgba(255,255,255,0.1); color: #fff;" onclick="switchTab('home', document.querySelectorAll('.nav-item')[0])">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="profile-screen" class="screen">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <div class="mode-card" style="background: linear-gradient(90deg, #38bdf8 0%, #818cf8 100%); color: #000;">
            <div class="mode-info"><h3 id="user-name">–ö–∏–Ω–æ–º–∞–Ω</h3><p id="user-id">ID: 000000</p></div>
        </div>
        <h3 style="margin-top: 30px;">–ö–æ–ª–ª–µ–∫—Ü–∏—è ‚ù§Ô∏è</h3>
        <div id="likes-list"></div>
    </div>

    <!-- –ü–û–î–î–ï–†–ñ–ö–ê -->
    <div id="support-screen" class="screen">
        <h1>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
        <p style="color:var(--text-dim); font-size:0.9rem; margin-bottom:15px;">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É, –º—ã –æ—Ç–≤–µ—Ç–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:</p>

        <textarea id="ticket-text" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button class="action-btn" onclick="createTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>

        <h3 style="margin-top: 30px;">–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
        <div id="my-tickets-list"></div>
    </div>

    <!-- –ê–î–ú–ò–ù–ö–ê -->
    <div id="admin-screen" class="screen">
        <h1>üõ† –ê–¥–º–∏–Ω–∫–∞</h1>
        <div class="stat-grid">
            <div class="stat-item"><div id="adm-users" class="stat-val">0</div><div class="stat-lbl">–Æ–∑–µ—Ä—ã</div></div>
            <div class="stat-item"><div id="adm-likes" class="stat-val">0</div><div class="stat-lbl">–õ–∞–π–∫–∏</div></div>
            <div class="stat-item"><div id="adm-rooms" class="stat-val">0</div><div class="stat-lbl">–ö–æ–º–Ω–∞—Ç—ã</div></div>
            <div class="stat-item"><div id="adm-tickets" class="stat-val">0</div><div class="stat-lbl">–¢–∏–∫–µ—Ç—ã</div></div>
        </div>
        <h3>üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h3>
        <textarea id="broadcast-text" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
        <button class="action-btn" onclick="sendBroadcast()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</button>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom:10px;">
            <h3>üì© –¢–∏–∫–µ—Ç—ã</h3>
            <button onclick="loadAdminData()" style="background:none; border:none; color:var(--accent); font-size:1.2rem;">üîÑ</button>
        </div>
        <div id="tickets-list"></div>
        <button class="action-btn" style="background: rgba(255,255,255,0.1); color: #fff; margin-top: 30px;" onclick="switchTab('home')">–í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏</button>
    </div>

            <nav class="nav-bar">
        <div class="nav-item active" onclick="handleSearchTab()">
            <span class="nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile', this)">
            <span class="nav-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <div class="nav-item" onclick="switchTab('support', this)">
            <span class="nav-icon">üì©</span><span>–ü–æ–º–æ—â—å</span>
        </div>
        <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∞ (—Å–∫—Ä—ã—Ç–∞—è) -->
        <div id="nav-admin" class="nav-item" style="display: none; color: #ff4b4b;" onclick="switchTab('admin', this)">
            <span class="nav-icon">üîë</span><span>–ê–¥–º–∏–Ω</span>
        </div>
    </nav>



    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.backgroundColor = '#0f172a';
        tg.headerColor = '#0f172a';

        const API_BASE = "https://larviparous-intercondylic-sherilyn.ngrok-free.dev".replace(/\/$/, "");

        let isLoading = false;
        let abortController = null;
        let currentMovieId = null;
        let currentGenre = 'all';
        let currentMode = 'solo';
        let myRoomId = null;
        let pollingInterval = null;
        let isSessionActive = false; // –§–ª–∞–≥: –∏–¥–µ—Ç –ª–∏ —Å–µ–π—á–∞—Å –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–µ–Ω—Ç—ã
        let lastMatchMovie = "";

        const GENRES = [
            {id: 'all', name: 'üé≤ –°–ª—É—á–∞–π–Ω—ã–µ'}, {id: '1', name: 'üí• –ë–æ–µ–≤–∏–∫'}, {id: '13', name: 'ü§° –ö–æ–º–µ–¥–∏—è'},
            {id: '17', name: 'üò± –£–∂–∞—Å—ã'}, {id: '18', name: 'üé≠ –î—Ä–∞–º–∞'}, {id: '12', name: 'üßö –§—ç–Ω—Ç–µ–∑–∏'},
            {id: '6', name: 'üöÄ –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞'}, {id: '10', name: 'ü§† –í–µ—Å—Ç–µ—Ä–Ω'}
        ];



function showMatchNotification(movieTitle) {
    if (movieTitle === lastMatchMovie) return;
    lastMatchMovie = movieTitle;

    tg.HapticFeedback.notificationOccurred('success');

    if (typeof confetti === 'function') {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            zIndex: 10002,
            // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–∫–∏
            disableForcibleRandomization: true
        });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –Ω–∞—Ö–æ–¥–∏–º —Ö–æ–ª—Å—Ç –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –µ–º—É –∫–ª–∏–∫–∏ —á–µ—Ä–µ–∑ CSS
        setTimeout(() => {
            const canvas = document.querySelector('canvas');
            if (canvas) canvas.style.pointerEvents = 'none';
        }, 10);
    }

    tg.showPopup({
        title: 'üéâ –£ –í–ê–° –ú–≠–¢–ß!',
        message: `–í—ã –æ–±–∞ —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å "${movieTitle}"`,
        buttons: [{type: 'ok', text: '–£—Ä–∞!'}]
    });

    setTimeout(() => {
        if (lastMatchMovie === movieTitle) lastMatchMovie = "";
    }, 10000);
}

        async function checkAdmin() {
            const uid = tg.initDataUnsafe.user?.id;
            if(!uid) return;
            try {
                const res = await fetch(`${API_BASE}/admin/check/${uid}`, {headers: {'ngrok-skip-browser-warning':'true'}});
                if(res.ok) {
                    const data = await res.json();
                    if(data.is_admin) document.getElementById('nav-admin').style.display = 'flex';
                }
            } catch(e) {}
        }
        checkAdmin();

        function renderGenres() {
            document.getElementById('genre-list').innerHTML = GENRES.map(g => `<div class="genre-btn" onclick="chooseGenre('${g.id}')">${g.name}</div>`).join('');
        }
        renderGenres();

        function switchTab(screen, el) {
    // 1. –°–∫—Ä—ã–≤–∞–µ–º –≤–æ–æ–±—â–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–æ–º screen
    document.querySelectorAll('.screen').forEach(s => {
        s.style.display = 'none';
        s.classList.remove('active');
    });

    // 2. –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

    // 3. –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —ç–∫—Ä–∞–Ω–∞: –∏—â–µ–º –ø–æ ID 'waiting', 'screen-waiting' –∏–ª–∏ 'waiting-screen'
    let targetScreen = document.getElementById(screen) ||
                       document.getElementById('screen-' + screen) ||
                       document.getElementById(screen + '-screen');

    if (targetScreen) {
        targetScreen.style.display = 'block';
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ active
        setTimeout(() => targetScreen.classList.add('active'), 10);
        currentTab = screen; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
    } else {
        console.error("–≠–∫—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω: " + screen);
    }

    // 4. –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é, –µ—Å–ª–∏ –æ–Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞
    if (el) el.classList.add('active');

    // 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    if(screen === 'profile') loadMyLikes();
    if(screen === 'admin') loadAdminData();
    if(screen === 'support') loadMyTickets();

    // 6. –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

        // --- –ü–û–î–î–ï–†–ñ–ö–ê ---
        async function createTicket() {
            const txt = document.getElementById('ticket-text').value;
            const uid = tg.initDataUnsafe.user?.id;
            if(!txt) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");

            try {
                await fetch(`${API_BASE}/create_ticket`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'ngrok-skip-browser-warning':'true'},
                    body: JSON.stringify({ user_id: uid, message: txt })
                });
                tg.showAlert("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
                document.getElementById('ticket-text').value = "";
                loadMyTickets();
            } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
        }

        async function loadMyTickets() {
            const uid = tg.initDataUnsafe.user?.id;
            try {
                const res = await fetch(`${API_BASE}/my_tickets/${uid}`, {headers:{'ngrok-skip-browser-warning':'true'}});
                const tickets = await res.json();
                const list = document.getElementById('my-tickets-list');

                if(!tickets.length) list.innerHTML = '<div style="text-align:center;color:gray;padding:20px">–û–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ—Ç</div>';
                else list.innerHTML = tickets.map(t => {
                    const statusClass = t.status === 'open' ? 'status-open' : 'status-closed';
                    const statusText = t.status === 'open' ? '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' : '–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω';

                    // –ë–ª–æ–∫ —Å –æ—Ç–≤–µ—Ç–æ–º –∞–¥–º–∏–Ω–∞
                    let replyBlock = '';
                    if (t.admin_reply) {
                        replyBlock = `<div class="admin-reply"><b>–û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏:</b><br>${t.admin_reply}</div>`;
                    }

                    return `
                    <div class="ticket-card">
                        <div class="ticket-header">
                            <span>${t.created_at.split(' ')[0]}</span>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div style="font-size:0.95rem; margin-bottom:5px;">üìù ${t.message}</div>
                        ${replyBlock}
                    </div>`;
                }).join('');
            } catch(e) {}
        }

        // --- –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        function handleSearchTab() {
    // 1. –£–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –∫–Ω–æ–ø–æ–∫ –≤ –º–µ–Ω—é
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(el => el.classList.remove('active'));
    if (navItems[0]) navItems[0].classList.add('active');

    // 2. –°–∫—Ä—ã–≤–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
    document.querySelectorAll('.screen').forEach(el => {
        el.style.display = 'none';
        el.classList.remove('active');
    });

    // 3. –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –Ω—É–∂–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    if (isSessionActive) {
        // –ò—â–µ–º —ç–∫—Ä–∞–Ω –ø–æ–∏—Å–∫–∞ (–ø–æ –æ–±–æ–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º ID)
        const searchScreen = document.getElementById('search-screen') || document.getElementById('screen-search');
        if (searchScreen) {
            searchScreen.style.display = 'block';
            searchScreen.classList.add('active');
        }
    } else {
        // –ò—â–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (—É —Ç–µ–±—è –≤ HTML –æ–Ω home-screen)
        const homeScreen = document.getElementById('home-screen') || document.getElementById('screen-home');
        if (homeScreen) {
            homeScreen.style.display = 'block';
            homeScreen.classList.add('active');
        }
    }

    // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –¥–æ–º–∏–∫
    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}

        function selectMode(mode) {
    // –ï—Å–ª–∏ –º—ã –±—ã–ª–∏ –≤ –ø–æ–∏—Å–∫–µ –∏ —Ä–µ—à–∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ–∏—Å–∫
    if (isSessionActive) {
        isSessionActive = false;
        if (pollingInterval) clearInterval(pollingInterval);
        // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º exitSearch —Å confirm, –ø—Ä–æ—Å—Ç–æ —Ç–∏—Ö–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
    }

    currentMode = mode;

    if (mode === 'solo') {
        switchTab('genre', document.querySelectorAll('.nav-item')[0]);
    } else if (mode === 'duo_create') {
        // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã –≤–¥–≤–æ–µ–º
        switchTab('genre', document.querySelectorAll('.nav-item')[0]);
    }
}
        async function chooseGenre(id) {
            currentGenre = id;
            if (currentMode === 'solo') startSearch();
            else await createRoomImpl();
        }
        function showDuoMenu() { switchTab('duo-menu', document.querySelectorAll('.nav-item')[0]); }
        function startSearch(partnerName = null) {
            isSessionActive = true; // <--- !!! –ù–û–í–ê–Ø –°–¢–†–û–ö–ê !!!
            switchTab('search', document.querySelectorAll('.nav-item')[0]);
            const badge = document.getElementById('partner-badge');
            if (partnerName) { badge.style.display = 'block'; badge.innerText = `–í –∫–æ–º–Ω–∞—Ç–µ —Å: ${partnerName}`; }
            else badge.style.display = 'none';
            loadMovie();
        }
        async function exitSearch() {
    if (!confirm("–í—ã–π—Ç–∏?")) return;

    isSessionActive = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–µ—Å—Å–∏–∏

    if (myRoomId) {
        const uid = tg.initDataUnsafe.user?.id;
        try {
            await fetch(`${API_BASE}/leave_room`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: uid, room_id: myRoomId })
            });
        } catch(e){}
    }

    myRoomId = null;
    if (pollingInterval) clearInterval(pollingInterval);

    // –û—á–∏—â–∞–µ–º –ø–æ—Å—Ç–µ—Ä, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –Ω–µ –º–∏–≥–∞–ª —Å—Ç–∞—Ä—ã–π —Ñ–∏–ª—å–º
    const poster = document.getElementById('poster');
    if (poster) {
        poster.classList.remove('loaded');
        poster.src = "";
    }

    // –í–ê–ñ–ù–û: –í–º–µ—Å—Ç–æ switchTab –∏—Å–ø–æ–ª—å–∑—É–µ–º handleSearchTab
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞/–∂–∞–Ω—Ä–∞
    handleSearchTab();
}

        async function createRoomImpl() {
    const uid = tg.initDataUnsafe.user?.id;
    try {
        const res = await fetch(`${API_BASE}/create_room`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
            body: JSON.stringify({ user_id: uid, user_name: tg.initDataUnsafe.user?.first_name, genre: currentGenre })
        });
        const data = await res.json();

        if (data && data.room_id) {
            myRoomId = data.room_id;
            document.getElementById('room-code-display').innerText = myRoomId;

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω. –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –∏–∑ –º–µ–Ω—é, —á—Ç–æ–±—ã switchTab —Å—Ä–∞–±–æ—Ç–∞–ª
            const anyNavItem = document.querySelector('.nav-item');
            switchTab('waiting', null);

            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(checkRoomStatus, 3000);
        }
    } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏"); }
}

async function checkRoomStatus() {
    if (!myRoomId) return;
    const uid = tg.initDataUnsafe.user?.id;

    try {
        const res = await fetch(`${API_BASE}/check_room/${myRoomId}?t=${Date.now()}`, {
            headers: {'ngrok-skip-browser-warning': 'true'}
        });
        const data = await res.json();

        if (data.status === 'joined') {
            // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            let partnerName = (uid === data.user1_id) ? data.user2_name : data.user1_name;
            const pb = document.getElementById('partner-name');
            if (pb && partnerName) {
                pb.innerText = partnerName;
                const badge = pb.closest('.partner-badge') || pb.parentElement;
                if (badge) badge.style.display = 'flex';
            }

            if (!isSessionActive) {
                isSessionActive = true;
                const waitingScreen = document.getElementById('waiting');
                if (waitingScreen) waitingScreen.style.display = 'none';
                switchTab('search', document.querySelector('.nav-item'));
                loadMovie();
            }
        }
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 'not_found' (–∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—å —É–¥–∞–ª–∏–ª –∫–æ–º–Ω–∞—Ç—É)
        else if ((data.status === 'waiting' || data.status === 'not_found') && isSessionActive) {
            // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            isSessionActive = false;

            // 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            // 3. –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            tg.showAlert("–ü–∞—Ä—Ç–Ω–µ—Ä –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞.");

            // 4. –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–Ø–ï–ú –ù–ê –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù
            switchTab('home', document.querySelector('.nav-item'));

            // 5. –ü–æ–ª–Ω–∞—è –∑–∞—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã
            myRoomId = null;
            if (typeof exitRoom === 'function') exitRoom();

            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º—ç—Ç—á–µ–π (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –µ—â–µ –∞–∫—Ç–∏–≤–Ω–∞)
        if (isSessionActive) {
            const mRes = await fetch(`${API_BASE}/check_matches/${uid}?t=${Date.now()}`, {
                headers: {'ngrok-skip-browser-warning': 'true'}
            });
            const mData = await mRes.json();
            if (mData.status === 'match') {
                showMatchNotification(mData.movie);
            }
        }
    } catch (e) {
        console.error("Polling error:", e);
    }
}


        function promptJoinRoom() { const code = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:"); if (code) joinRoom(code); }
        async function joinRoom(code) {
            const uid = tg.initDataUnsafe.user?.id;
            const name = tg.initDataUnsafe.user?.first_name || "–ò–≥—Ä–æ–∫ 2";
            try {
                const res = await fetch(`${API_BASE}/join_room`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: uid, user_name: name, room_id: code }) });
                const data = await res.json();
                if (data.status === 'success') { myRoomId = code; currentGenre = data.genre; tg.showAlert("–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ!"); startSearch(data.partner_name); }
                else tg.showAlert(data.message);
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞"); }
        }

        async function loadMovie() {
    // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const uid = tg.initDataUnsafe.user?.id;
    if (!uid) return;

    // –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ö–û–ú–ù–ê–¢–´ (–¥–ª—è —Ä–µ–∂–∏–º–∞ –≤–¥–≤–æ–µ–º)
    if (myRoomId) {
        try {
            const checkRes = await fetch(`${API_BASE}/check_room/${myRoomId}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const statusData = await checkRes.json();

            // –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä –≤—ã—à–µ–ª –∏–ª–∏ –∫–æ–º–Ω–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞, —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω–µ—Ç 'waiting' –∏–ª–∏ –æ—à–∏–±–∫—É
            if (statusData.status === 'waiting') {
                tg.showAlert("–ü–∞—Ä—Ç–Ω–µ—Ä –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ–ª–æ-—Ä–µ–∂–∏–º.");
                myRoomId = null;
                // –°–∫—Ä—ã–≤–∞–µ–º –±–µ–π–¥–∂ –ø–∞—Ä—Ç–Ω–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ –≤–µ—Ä—Å—Ç–∫–µ
                const badge = document.getElementById('partner-badge');
                if (badge) badge.style.display = 'none';
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–Ω–∞—Ç—ã:", e);
        }
    }

    if (isLoading && abortController) abortController.abort();

    isLoading = true;
    abortController = new AbortController();

    document.getElementById('title').innerText = "–ü–æ–¥–±–∏—Ä–∞–µ–º...";
    document.getElementById('poster').classList.remove('loaded');

    try {
        // 2. –î–æ–±–∞–≤–∏–ª–∏ user_id=${uid} –≤ –∑–∞–ø—Ä–æ—Å
        const url = `${API_BASE}/get_movie?user_id=${uid}&genre=${currentGenre}&nocache=${Date.now()}`;

        const res = await fetch(url, {
            headers: { 'ngrok-skip-browser-warning': 'true' },
            signal: abortController.signal
        });

        const data = await res.json();

        // –ï—Å–ª–∏ —Ñ–∏–ª—å–º—ã –∫–æ–Ω—á–∏–ª–∏—Å—å (—Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Ç–∞–∫–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫)
        if (data.title === "–§–∏–ª—å–º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å") {
            document.getElementById('title').innerText = "–§–∏–ª—å–º—ã –∫–æ–Ω—á–∏–ª–∏—Å—å üòî";
            document.getElementById('desc').innerText = "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–º–µ–Ω–∏—Ç—å –∂–∞–Ω—Ä.";
            document.getElementById('poster').src = "https://placehold.co/400x600/1e293b/FFF?text=End";
            isLoading = false;
            return;
        }

        currentMovieId = data.id;
        document.getElementById('title').innerText = data.title;
        document.getElementById('poster').src = data.poster;
        document.getElementById('poster-blur').src = data.poster;
        document.getElementById('desc').innerText = data.description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
        document.getElementById('rating').innerText = data.rating;
        document.getElementById('meta').innerText = `${data.year} ‚Ä¢ ${data.genres}`;

        document.getElementById('poster').onload = () => {
            document.getElementById('poster').classList.add('loaded');
            isLoading = false;
        };
    } catch (e) {
        if(e.name !== 'AbortError') {
            isLoading = false;
            document.getElementById('title').innerText = "–û—à–∏–±–∫–∞ üîÑ";
        }
    }
}


       async function handleLike() {
    const uid = tg.initDataUnsafe.user?.id;
    if(!uid || !currentMovieId || isLoading) return;

    isLoading = true;
    const title = document.getElementById('title').innerText;
    const poster = document.getElementById('poster').src;

    try {
        const res = await fetch(`${API_BASE}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify({
                user_id: uid,
                movie_id: currentMovieId,
                movie_title: title,
                poster_url: poster
            })
        });

        const data = await res.json();

        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Å—Ä–∞–∑—É –≤–µ—Ä–Ω—É–ª –º—ç—Ç—á ‚Äî –≤—ã–∑—ã–≤–∞–µ–º –µ–¥–∏–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        if (data.status === 'match') {
    showMatchNotification(title);
}

        isLoading = false;
        loadMovie(); // –ì—Ä—É–∑–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∏–ª—å–º
    } catch(e) {
        console.error(e);
        isLoading = false;
    }
}

async function handleDislike() {
    if (isLoading) return;
    const uid = tg.initDataUnsafe.user?.id;
    const title = document.getElementById('title').innerText;

    loadMovie();

    try {
        await fetch(`${API_BASE}/dislike`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify({
                user_id: uid,
                movie_id: currentMovieId,
                movie_title: title,
                poster_url: ""
            })
        });
    } catch (e) {}
}


        async function loadMyLikes() {
            const uid = tg.initDataUnsafe.user?.id;
            try {
                const res = await fetch(`${API_BASE}/get_likes/${uid}`, {headers: {'ngrok-skip-browser-warning': 'true'}});
                const data = await res.json();
                document.getElementById('likes-list').innerHTML = data.length ? data.map(m => `<div class="mode-card" style="padding:10px;"><img src="${m.poster}" style="width:40px;height:60px;border-radius:8px;margin-right:10px;"><div>${m.title}</div></div>`).join('') : '<div style="text-align:center;color:gray;">–ü—É—Å—Ç–æ</div>';
            } catch(e) {}
        }

        // –ê–¥–º–∏–Ω–∫–∞
        async function loadAdminData() {
            const uid = tg.initDataUnsafe.user?.id;
            const h = { 'ngrok-skip-browser-warning': 'true' };
            const s = await (await fetch(`${API_BASE}/admin/stats/${uid}`, { headers: h })).json();
            document.getElementById('adm-users').innerText = s.users; document.getElementById('adm-likes').innerText = s.likes;
            document.getElementById('adm-rooms').innerText = s.rooms; document.getElementById('adm-tickets').innerText = s.tickets;
            const t = await (await fetch(`${API_BASE}/admin/tickets/${uid}`, { headers: h })).json();
            document.getElementById('tickets-list').innerHTML = t.map(tik =>
                `<div class="ticket-card"><div class="ticket-header"><span>${tik.user_id}</span><span>${tik.msg_type}</span></div><div style="margin-bottom:8px">"${tik.message}"</div><div class="reply-box"><input id="rep-${tik.id}" class="reply-input"><button onclick="reply(${tik.id})" style="background:var(--accent);border:none;border-radius:8px;">‚ûú</button></div></div>`
            ).join('');
        }
        async function reply(tid) {
            const txt = document.getElementById(`rep-${tid}`).value;
            const uid = tg.initDataUnsafe.user?.id;
            await fetch(`${API_BASE}/admin/reply_ticket`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({admin_id:uid, ticket_id:tid, text:txt})});
            loadAdminData();
        }
        async function sendBroadcast() {
            const txt = document.getElementById('broadcast-text').value;
            const uid = tg.initDataUnsafe.user?.id;
            if(confirm("–í—Å–µ–º?")) await fetch(`${API_BASE}/admin/broadcast`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({admin_id:uid, text:txt})});
        }

        document.getElementById('user-name').innerText = tg.initDataUnsafe.user?.first_name || "–ö–∏–Ω–æ–º–∞–Ω";
        document.getElementById('user-id').innerText = "ID: " + (tg.initDataUnsafe.user?.id || "---");
    </script>
</body>
</html>
